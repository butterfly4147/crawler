# åˆ†å¸ƒå¼çˆ¬è™«é¡¹ç›®å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ åœ¨**30åˆ†é’Ÿå†…**å¿«é€Ÿæ­å»ºå¹¶è¿è¡Œåˆ†å¸ƒå¼çˆ¬è™«é¡¹ç›®ï¼Œç†è§£å…¶åŸºæœ¬å·¥ä½œåŸç†ã€‚é€‚åˆæœ‰Goè¯­è¨€åŸºç¡€çš„å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ã€‚

## ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 11 (å½“å‰ç¯å¢ƒ)
- **Goç‰ˆæœ¬**: 1.19+ (æ¨è1.21+)
- **å†…å­˜**: æœ€å°‘4GBï¼Œæ¨è8GB+
- **ç£ç›˜**: è‡³å°‘2GBå¯ç”¨ç©ºé—´

### ä¾èµ–è½¯ä»¶
- **MySQL**: 5.7+ æˆ– 8.0+
- **etcd**: 3.5+
- **Docker**: 20.10+ (å¯é€‰ï¼Œæ¨è)
- **Git**: æœ€æ–°ç‰ˆæœ¬

## å¿«é€Ÿå¯åŠ¨ (Dockeræ–¹å¼) âš¡

### æ­¥éª¤1: å…‹éš†é¡¹ç›® (2åˆ†é’Ÿ)

```powershell
# 1. å…‹éš†é¡¹ç›®
git clone <é¡¹ç›®åœ°å€>
cd crawler

# 2. æŸ¥çœ‹é¡¹ç›®ç»“æ„
tree /F . | head -20

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶
type config.toml
type docker-compose.yml
```

### æ­¥éª¤2: ä¸€é”®å¯åŠ¨ (5åˆ†é’Ÿ)

```powershell
# 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡ (MySQL + etcd + Master + Worker)
docker-compose up -d

# 2. ç­‰å¾…æœåŠ¡å¯åŠ¨ (çº¦30ç§’)
Start-Sleep -Seconds 30

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æœŸæœ›è¾“å‡º:
# NAME                COMMAND                  SERVICE             STATUS              PORTS
# crawler-master-1    "./crawler master --â€¦"   master              running             0.0.0.0:8082->8082/tcp, 0.0.0.0:9092->9092/tcp
# crawler-worker-1    "./crawler worker --â€¦"   worker              running             0.0.0.0:8080->8080/tcp, 0.0.0.0:9090->9090/tcp
# crawler-etcd-1      "etcd --data-dir=defâ€¦"   etcd                running             2379-2380/tcp
# crawler-mysql-1     "docker-entrypoint.sâ€¦"   mysql               running             3306/tcp
```

### æ­¥éª¤3: éªŒè¯è¿è¡Œ (3åˆ†é’Ÿ)

```powershell
# 1. æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8082/health  # Masterå¥åº·æ£€æŸ¥
curl http://localhost:8080/health  # Workerå¥åº·æ£€æŸ¥

# 2. æŸ¥çœ‹æœåŠ¡æ³¨å†Œæƒ…å†µ
docker exec crawler-etcd-1 etcdctl get --prefix /micro/registry/

# 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec crawler-mysql-1 mysql -u root -p123456 -e "SHOW DATABASES;"
```

### æ­¥éª¤4: è¿è¡Œç¬¬ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡ (5åˆ†é’Ÿ)

```powershell
# 1. æ·»åŠ çˆ¬è™«ä»»åŠ¡
$body = @{
    name = "example_baidu_home"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8082/crawler/resource" -Method POST -Body $body -ContentType "application/json"

# 2. ç­‰å¾…ä»»åŠ¡æ‰§è¡Œ (çº¦10ç§’)
Start-Sleep -Seconds 10

# 3. æŸ¥çœ‹çˆ¬å–ç»“æœ
docker exec crawler-mysql-1 mysql -u root -p123456 -e "USE crawler; SHOW TABLES;"
docker exec crawler-mysql-1 mysql -u root -p123456 -e "USE crawler; SELECT * FROM example_baidu_home LIMIT 5;"
```

### æ­¥éª¤5: è§‚å¯Ÿåˆ†å¸ƒå¼ç‰¹æ€§ (5åˆ†é’Ÿ)

```powershell
# 1. æŸ¥çœ‹Masteré€‰ä¸¾çŠ¶æ€
docker logs crawler-master-1 | Select-String "leader"

# 2. æŸ¥çœ‹Workerä»»åŠ¡æ‰§è¡Œ
docker logs crawler-worker-1 | Select-String "task"

# 3. æ¨¡æ‹ŸèŠ‚ç‚¹æ•…éšœ
docker stop crawler-worker-1
Start-Sleep -Seconds 5
docker start crawler-worker-1

# 4. è§‚å¯Ÿæ•…éšœæ¢å¤
docker logs crawler-master-1 | tail -10
```

## æ‰‹åŠ¨å¯åŠ¨æ–¹å¼ (æ·±åº¦å­¦ä¹ æ¨è)

### æ­¥éª¤1: ç¯å¢ƒå‡†å¤‡ (10åˆ†é’Ÿ)

#### å®‰è£…MySQL
```powershell
# æ–¹å¼1: ä½¿ç”¨Chocolatey (æ¨è)
choco install mysql

# æ–¹å¼2: æ‰‹åŠ¨ä¸‹è½½å®‰è£…
# ä¸‹è½½MySQL 8.0 Community Server
# è®¾ç½®rootå¯†ç : 123456

# åˆ›å»ºæ•°æ®åº“
mysql -u root -p123456 -e "CREATE DATABASE IF NOT EXISTS crawler DEFAULT CHARSET utf8;"
```

#### å®‰è£…etcd
```powershell
# 1. ä¸‹è½½etcd
$etcdVersion = "v3.5.9"
$downloadUrl = "https://github.com/etcd-io/etcd/releases/download/$etcdVersion/etcd-$etcdVersion-windows-amd64.zip"
Invoke-WebRequest -Uri $downloadUrl -OutFile "etcd.zip"

# 2. è§£å‹å¹¶æ·»åŠ åˆ°PATH
Expand-Archive -Path "etcd.zip" -DestinationPath "."
$etcdPath = (Get-Location).Path + "\etcd-$etcdVersion-windows-amd64"
$env:PATH += ";$etcdPath"

# 3. éªŒè¯å®‰è£…
etcd --version
```

### æ­¥éª¤2: ç¼–è¯‘é¡¹ç›® (3åˆ†é’Ÿ)

```powershell
# 1. ä¸‹è½½ä¾èµ–
go mod download

# 2. ç¼–è¯‘é¡¹ç›®
go build -o crawler.exe .

# 3. éªŒè¯ç¼–è¯‘
.\crawler.exe --help
```

### æ­¥éª¤3: å¯åŠ¨æœåŠ¡ (5åˆ†é’Ÿ)

#### ç»ˆç«¯1: å¯åŠ¨etcd
```powershell
# å¯åŠ¨etcdæœåŠ¡
etcd --data-dir=default.etcd --listen-client-urls=http://127.0.0.1:2379 --advertise-client-urls=http://127.0.0.1:2379
```

#### ç»ˆç«¯2: å¯åŠ¨Master
```powershell
# å¯åŠ¨MasterèŠ‚ç‚¹
.\crawler.exe master --id=2 --http=:8082 --grpc=:9092 --pprof=:9982

# æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—:
# INFO    master/master.go:xxx    å¼€å§‹é€‰ä¸¾...
# INFO    master/master.go:xxx    æˆä¸ºLeader
# INFO    master/master.go:xxx    MasteræœåŠ¡å¯åŠ¨æˆåŠŸ
```

#### ç»ˆç«¯3: å¯åŠ¨Worker
```powershell
# å¯åŠ¨WorkerèŠ‚ç‚¹
.\crawler.exe worker --id=1 --http=:8080 --grpc=:9090

# æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—:
# INFO    worker/worker.go:xxx    WorkeræœåŠ¡å¯åŠ¨æˆåŠŸ
# INFO    engine/schedule.go:xxx  å¼€å§‹ç›‘å¬èµ„æºå˜åŒ–...
```

### æ­¥éª¤4: æµ‹è¯•åŠŸèƒ½ (7åˆ†é’Ÿ)

```powershell
# 1. å¥åº·æ£€æŸ¥
curl http://localhost:8082/health
curl http://localhost:8080/health

# 2. æŸ¥çœ‹æœåŠ¡æ³¨å†Œ
etcdctl get --prefix /micro/registry/

# 3. æ·»åŠ çˆ¬è™«ä»»åŠ¡
$headers = @{ "Content-Type" = "application/json" }
$body = '{"name": "example_baidu_home"}'
Invoke-RestMethod -Uri "http://localhost:8082/crawler/resource" -Method POST -Body $body -Headers $headers

# 4. æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œç»“æœ
mysql -u root -p123456 -e "USE crawler; SELECT COUNT(*) FROM example_baidu_home;"

# 5. æŸ¥çœ‹è¯¦ç»†æ•°æ®
mysql -u root -p123456 -e "USE crawler; SELECT * FROM example_baidu_home LIMIT 3\G"
```

## æ ¸å¿ƒæ¦‚å¿µç†è§£

### 1. Master-Workeræ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    é€‰ä¸¾    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Master1   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Master2   â”‚
â”‚  (Leader)   â”‚            â”‚ (Follower)  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ ä»»åŠ¡åˆ†é…
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worker1   â”‚            â”‚   Worker2   â”‚
â”‚  (æ‰§è¡Œè€…)    â”‚            â”‚  (æ‰§è¡Œè€…)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç†è§£**:
- **Master**: è´Ÿè´£ä»»åŠ¡åˆ†é…å’Œé›†ç¾¤ç®¡ç†ï¼Œé€šè¿‡etcdé€‰ä¸¾äº§ç”ŸLeader
- **Worker**: è´Ÿè´£å…·ä½“çš„çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ
- **etcd**: æä¾›æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’Œåˆ†å¸ƒå¼é”

### 2. ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
1. ç”¨æˆ·æ·»åŠ ä»»åŠ¡ â†’ Masteræ¥æ”¶
2. Masteråˆ†é…ä»»åŠ¡ â†’ Workerç›‘å¬
3. Workeræ‰§è¡Œçˆ¬è™« â†’ è§£ææ•°æ®
4. æ•°æ®å­˜å‚¨åˆ°MySQL â†’ ä»»åŠ¡å®Œæˆ
```

### 3. å…³é”®ç»„ä»¶è¯´æ˜

| ç»„ä»¶ | ä½œç”¨ | ç±»æ¯”æ¸¸æˆæœåŠ¡å™¨ |
|------|------|----------------|
| Master | ä»»åŠ¡è°ƒåº¦ã€è´Ÿè½½å‡è¡¡ | æ¸¸æˆä¸»æœåŠ¡å™¨ |
| Worker | ä»»åŠ¡æ‰§è¡Œã€æ•°æ®æŠ“å– | æ¸¸æˆæˆ¿é—´æœåŠ¡å™¨ |
| etcd | æœåŠ¡æ³¨å†Œã€é…ç½®ç®¡ç† | æœåŠ¡æ³¨å†Œä¸­å¿ƒ |
| MySQL | æ•°æ®å­˜å‚¨ | æ¸¸æˆæ•°æ®åº“ |
| gRPC | æœåŠ¡é—´é€šä¿¡ | RPCé€šä¿¡ |

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æœåŠ¡å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: Masteræˆ–Workerå¯åŠ¨æ—¶æŠ¥é”™
```
ERROR   master/master.go:xxx    failed to connect to etcd
```

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# 1. æ£€æŸ¥etcdæ˜¯å¦å¯åŠ¨
netstat -an | findstr 2379

# 2. æ£€æŸ¥etcdè¿æ¥
etcdctl endpoint health

# 3. é‡å¯etcd
taskkill /F /IM etcd.exe
etcd --data-dir=default.etcd --listen-client-urls=http://127.0.0.1:2379 --advertise-client-urls=http://127.0.0.1:2379
```

### é—®é¢˜2: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: 
```
ERROR   storage/sqlstorage.go:xxx    failed to connect to database
```

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# 1. æ£€æŸ¥MySQLæœåŠ¡
Get-Service -Name MySQL*

# 2. æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u root -p123456 -e "SELECT 1;"

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
type config.toml | findstr mysql
```

### é—®é¢˜3: ä»»åŠ¡ä¸æ‰§è¡Œ

**ç—‡çŠ¶**: æ·»åŠ ä»»åŠ¡åæ²¡æœ‰æ•°æ®äº§ç”Ÿ

**æ’æŸ¥æ­¥éª¤**:
```powershell
# 1. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ·»åŠ æˆåŠŸ
curl http://localhost:8082/crawler/resource

# 2. æŸ¥çœ‹Workeræ—¥å¿—
# åœ¨Workerç»ˆç«¯æŸ¥çœ‹æ˜¯å¦æœ‰ä»»åŠ¡æ¥æ”¶æ—¥å¿—

# 3. æ£€æŸ¥æ•°æ®åº“è¡¨æ˜¯å¦åˆ›å»º
mysql -u root -p123456 -e "USE crawler; SHOW TABLES;"

# 4. æŸ¥çœ‹etcdä¸­çš„ä»»åŠ¡ä¿¡æ¯
etcdctl get --prefix /resources/
```

### é—®é¢˜4: ç«¯å£å†²çª

**ç—‡çŠ¶**: 
```
ERROR   listen tcp :8080: bind: address already in use
```

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# 1. æŸ¥çœ‹ç«¯å£å ç”¨
netstat -ano | findstr :8080

# 2. æ€æ­»å ç”¨è¿›ç¨‹
taskkill /F /PID <è¿›ç¨‹ID>

# 3. æˆ–è€…ä¿®æ”¹é…ç½®ä½¿ç”¨å…¶ä»–ç«¯å£
.\crawler.exe worker --id=1 --http=:8081 --grpc=:9091
```

### é—®é¢˜5: æƒé™é—®é¢˜

**ç—‡çŠ¶**: Dockeræˆ–æ–‡ä»¶æ“ä½œæƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# 1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒPowerShell
Start-Process powershell -Verb runAs

# 2. æ£€æŸ¥Dockeræƒé™
docker version

# 3. æ£€æŸ¥æ–‡ä»¶æƒé™
icacls . /grant Everyone:F
```

## æ€§èƒ½ç›‘æ§

### åŸºæœ¬ç›‘æ§å‘½ä»¤

```powershell
# 1. æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨
Get-Process -Name crawler | Select-Object CPU,WorkingSet,VirtualMemorySize

# 2. æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -an | findstr "8080\|8082\|9090\|9092"

# 3. æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ•°
mysql -u root -p123456 -e "SHOW PROCESSLIST;"

# 4. æŸ¥çœ‹etcdçŠ¶æ€
etcdctl endpoint status --write-out=table
```

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | ç›‘æ§å‘½ä»¤ |
|------|----------|----------|
| CPUä½¿ç”¨ç‡ | < 80% | `Get-Counter "\Processor(_Total)\% Processor Time"` |
| å†…å­˜ä½¿ç”¨ | < 2GB | `Get-Process crawler \| Measure-Object WorkingSet -Sum` |
| ç½‘ç»œè¿æ¥ | < 1000 | `netstat -an \| findstr ESTABLISHED \| Measure-Object` |
| æ•°æ®åº“è¿æ¥ | < 100 | `mysql -e "SHOW STATUS LIKE 'Threads_connected';"` |

## ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

### ç«‹å³å¯ä»¥å°è¯•çš„å®éªŒ

1. **ä¿®æ”¹çˆ¬è™«ä»»åŠ¡**:
   ```go
   // åœ¨ parse/minimal/minimal.go ä¸­æ·»åŠ æ–°çš„è§£æè§„åˆ™
   // å°è¯•çˆ¬å–ä¸åŒçš„ç½‘ç«™
   ```

2. **è°ƒæ•´å¹¶å‘å‚æ•°**:
   ```toml
   # åœ¨ config.toml ä¸­ä¿®æ”¹
   [fetcher]
   timeout = "5s"
   # æ·»åŠ å¹¶å‘æ§åˆ¶å‚æ•°
   ```

3. **æ·»åŠ æ–°çš„å­˜å‚¨æ–¹å¼**:
   ```go
   // å®ç° storage.Storage æ¥å£
   // æ”¯æŒæ–‡ä»¶å­˜å‚¨æˆ–Rediså­˜å‚¨
   ```

### æ·±å…¥å­¦ä¹ è·¯å¾„

1. **ç¬¬1å‘¨**: ç†Ÿæ‚‰åŸºæœ¬æ“ä½œå’Œé…ç½®
2. **ç¬¬2å‘¨**: ç†è§£åˆ†å¸ƒå¼åè°ƒæœºåˆ¶
3. **ç¬¬3å‘¨**: æŒæ¡çˆ¬è™«è§„åˆ™ç¼–å†™
4. **ç¬¬4å‘¨**: å­¦ä¹ æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

### æ¨èé˜…è¯»

- `docs/traeauto/00_é¡¹ç›®æ¶æ„æ€»è§ˆ.md` - æ¶æ„è®¾è®¡ç†è§£
- `docs/traeauto/01_æ ¸å¿ƒæ¨¡å—æ·±åº¦è§£æ.md` - ä»£ç å®ç°ç»†èŠ‚
- `docs/traeauto/02_å­¦ä¹ è·¯çº¿å›¾.md` - ç³»ç»Ÿå­¦ä¹ è®¡åˆ’

## æ€»ç»“

é€šè¿‡æœ¬å¿«é€Ÿä¸Šæ‰‹æŒ‡å—ï¼Œä½ åº”è¯¥èƒ½å¤Ÿ:

âœ… **ç¯å¢ƒæ­å»º**: æˆåŠŸå¯åŠ¨å®Œæ•´çš„åˆ†å¸ƒå¼çˆ¬è™«ç³»ç»Ÿ
âœ… **åŸºæœ¬æ“ä½œ**: æ·»åŠ ä»»åŠ¡ã€æŸ¥çœ‹ç»“æœã€ç›‘æ§çŠ¶æ€
âœ… **æ¶æ„ç†è§£**: æŒæ¡Master-Workeråˆ†å¸ƒå¼æ¶æ„
âœ… **é—®é¢˜æ’æŸ¥**: å…·å¤‡åŸºæœ¬çš„æ•…éšœè¯Šæ–­èƒ½åŠ›

**ä¸‹ä¸€æ­¥**: æ ¹æ®å­¦ä¹ è·¯çº¿å›¾è¿›è¡Œæ·±å…¥å­¦ä¹ ï¼Œé€æ­¥æŒæ¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°åŸç†ã€‚

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥:
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æ’æŸ¥é”™è¯¯
2. å‚è€ƒå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
3. é˜…è¯»è¯¦ç»†çš„æ¶æ„æ–‡æ¡£
4. è¿›è¡Œä»£ç è°ƒè¯•å’Œåˆ†æ

ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸš€