# 分布式爬虫项目快速上手指南

## 概述

本指南将帮助你在**30分钟内**快速搭建并运行分布式爬虫项目，理解其基本工作原理。适合有Go语言基础的开发者快速上手。

## 环境要求

### 系统要求
- **操作系统**: Windows 11 (当前环境)
- **Go版本**: 1.19+ (推荐1.21+)
- **内存**: 最少4GB，推荐8GB+
- **磁盘**: 至少2GB可用空间

### 依赖软件
- **MySQL**: 5.7+ 或 8.0+
- **etcd**: 3.5+
- **Docker**: 20.10+ (可选，推荐)
- **Git**: 最新版本

## 快速启动 (Docker方式) ⚡

### 步骤1: 克隆项目 (2分钟)

```powershell
# 1. 克隆项目
git clone <项目地址>
cd crawler

# 2. 查看项目结构
tree /F . | head -20

# 3. 检查配置文件
type config.toml
type docker-compose.yml
```

### 步骤2: 一键启动 (5分钟)

```powershell
# 1. 启动所有服务 (MySQL + etcd + Master + Worker)
docker-compose up -d

# 2. 等待服务启动 (约30秒)
Start-Sleep -Seconds 30

# 3. 检查服务状态
docker-compose ps

# 期望输出:
# NAME                COMMAND                  SERVICE             STATUS              PORTS
# crawler-master-1    "./crawler master --…"   master              running             0.0.0.0:8082->8082/tcp, 0.0.0.0:9092->9092/tcp
# crawler-worker-1    "./crawler worker --…"   worker              running             0.0.0.0:8080->8080/tcp, 0.0.0.0:9090->9090/tcp
# crawler-etcd-1      "etcd --data-dir=def…"   etcd                running             2379-2380/tcp
# crawler-mysql-1     "docker-entrypoint.s…"   mysql               running             3306/tcp
```

### 步骤3: 验证运行 (3分钟)

```powershell
# 1. 检查服务健康状态
curl http://localhost:8082/health  # Master健康检查
curl http://localhost:8080/health  # Worker健康检查

# 2. 查看服务注册情况
docker exec crawler-etcd-1 etcdctl get --prefix /micro/registry/

# 3. 检查数据库连接
docker exec crawler-mysql-1 mysql -u root -p123456 -e "SHOW DATABASES;"
```

### 步骤4: 运行第一个爬虫任务 (5分钟)

```powershell
# 1. 添加爬虫任务
$body = @{
    name = "example_baidu_home"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8082/crawler/resource" -Method POST -Body $body -ContentType "application/json"

# 2. 等待任务执行 (约10秒)
Start-Sleep -Seconds 10

# 3. 查看爬取结果
docker exec crawler-mysql-1 mysql -u root -p123456 -e "USE crawler; SHOW TABLES;"
docker exec crawler-mysql-1 mysql -u root -p123456 -e "USE crawler; SELECT * FROM example_baidu_home LIMIT 5;"
```

### 步骤5: 观察分布式特性 (5分钟)

```powershell
# 1. 查看Master选举状态
docker logs crawler-master-1 | Select-String "leader"

# 2. 查看Worker任务执行
docker logs crawler-worker-1 | Select-String "task"

# 3. 模拟节点故障
docker stop crawler-worker-1
Start-Sleep -Seconds 5
docker start crawler-worker-1

# 4. 观察故障恢复
docker logs crawler-master-1 | tail -10
```

## 手动启动方式 (深度学习推荐)

### 步骤1: 环境准备 (10分钟)

#### 安装MySQL
```powershell
# 方式1: 使用Chocolatey (推荐)
choco install mysql

# 方式2: 手动下载安装
# 下载MySQL 8.0 Community Server
# 设置root密码: 123456

# 创建数据库
mysql -u root -p123456 -e "CREATE DATABASE IF NOT EXISTS crawler DEFAULT CHARSET utf8;"
```

#### 安装etcd
```powershell
# 1. 下载etcd
$etcdVersion = "v3.5.9"
$downloadUrl = "https://github.com/etcd-io/etcd/releases/download/$etcdVersion/etcd-$etcdVersion-windows-amd64.zip"
Invoke-WebRequest -Uri $downloadUrl -OutFile "etcd.zip"

# 2. 解压并添加到PATH
Expand-Archive -Path "etcd.zip" -DestinationPath "."
$etcdPath = (Get-Location).Path + "\etcd-$etcdVersion-windows-amd64"
$env:PATH += ";$etcdPath"

# 3. 验证安装
etcd --version
```

### 步骤2: 编译项目 (3分钟)

```powershell
# 1. 下载依赖
go mod download

# 2. 编译项目
go build -o crawler.exe .

# 3. 验证编译
.\crawler.exe --help
```

### 步骤3: 启动服务 (5分钟)

#### 终端1: 启动etcd
```powershell
# 启动etcd服务
etcd --data-dir=default.etcd --listen-client-urls=http://127.0.0.1:2379 --advertise-client-urls=http://127.0.0.1:2379
```

#### 终端2: 启动Master
```powershell
# 启动Master节点
.\crawler.exe master --id=2 --http=:8082 --grpc=:9092 --pprof=:9982

# 期望看到的日志:
# INFO    master/master.go:xxx    开始选举...
# INFO    master/master.go:xxx    成为Leader
# INFO    master/master.go:xxx    Master服务启动成功
```

#### 终端3: 启动Worker
```powershell
# 启动Worker节点
.\crawler.exe worker --id=1 --http=:8080 --grpc=:9090

# 期望看到的日志:
# INFO    worker/worker.go:xxx    Worker服务启动成功
# INFO    engine/schedule.go:xxx  开始监听资源变化...
```

### 步骤4: 测试功能 (7分钟)

```powershell
# 1. 健康检查
curl http://localhost:8082/health
curl http://localhost:8080/health

# 2. 查看服务注册
etcdctl get --prefix /micro/registry/

# 3. 添加爬虫任务
$headers = @{ "Content-Type" = "application/json" }
$body = '{"name": "example_baidu_home"}'
Invoke-RestMethod -Uri "http://localhost:8082/crawler/resource" -Method POST -Body $body -Headers $headers

# 4. 查看任务执行结果
mysql -u root -p123456 -e "USE crawler; SELECT COUNT(*) FROM example_baidu_home;"

# 5. 查看详细数据
mysql -u root -p123456 -e "USE crawler; SELECT * FROM example_baidu_home LIMIT 3\G"
```

## 核心概念理解

### 1. Master-Worker架构

```
┌─────────────┐    选举    ┌─────────────┐
│   Master1   │◄─────────►│   Master2   │
│  (Leader)   │            │ (Follower)  │
└─────┬───────┘            └─────────────┘
      │ 任务分配
      ▼
┌─────────────┐            ┌─────────────┐
│   Worker1   │            │   Worker2   │
│  (执行者)    │            │  (执行者)    │
└─────────────┘            └─────────────┘
```

**关键理解**:
- **Master**: 负责任务分配和集群管理，通过etcd选举产生Leader
- **Worker**: 负责具体的爬虫任务执行
- **etcd**: 提供服务发现、配置管理和分布式锁

### 2. 任务执行流程

```
1. 用户添加任务 → Master接收
2. Master分配任务 → Worker监听
3. Worker执行爬虫 → 解析数据
4. 数据存储到MySQL → 任务完成
```

### 3. 关键组件说明

| 组件 | 作用 | 类比游戏服务器 |
|------|------|----------------|
| Master | 任务调度、负载均衡 | 游戏主服务器 |
| Worker | 任务执行、数据抓取 | 游戏房间服务器 |
| etcd | 服务注册、配置管理 | 服务注册中心 |
| MySQL | 数据存储 | 游戏数据库 |
| gRPC | 服务间通信 | RPC通信 |

## 常见问题排查

### 问题1: 服务启动失败

**症状**: Master或Worker启动时报错
```
ERROR   master/master.go:xxx    failed to connect to etcd
```

**解决方案**:
```powershell
# 1. 检查etcd是否启动
netstat -an | findstr 2379

# 2. 检查etcd连接
etcdctl endpoint health

# 3. 重启etcd
taskkill /F /IM etcd.exe
etcd --data-dir=default.etcd --listen-client-urls=http://127.0.0.1:2379 --advertise-client-urls=http://127.0.0.1:2379
```

### 问题2: 数据库连接失败

**症状**: 
```
ERROR   storage/sqlstorage.go:xxx    failed to connect to database
```

**解决方案**:
```powershell
# 1. 检查MySQL服务
Get-Service -Name MySQL*

# 2. 测试数据库连接
mysql -u root -p123456 -e "SELECT 1;"

# 3. 检查配置文件中的数据库连接字符串
type config.toml | findstr mysql
```

### 问题3: 任务不执行

**症状**: 添加任务后没有数据产生

**排查步骤**:
```powershell
# 1. 检查任务是否添加成功
curl http://localhost:8082/crawler/resource

# 2. 查看Worker日志
# 在Worker终端查看是否有任务接收日志

# 3. 检查数据库表是否创建
mysql -u root -p123456 -e "USE crawler; SHOW TABLES;"

# 4. 查看etcd中的任务信息
etcdctl get --prefix /resources/
```

### 问题4: 端口冲突

**症状**: 
```
ERROR   listen tcp :8080: bind: address already in use
```

**解决方案**:
```powershell
# 1. 查看端口占用
netstat -ano | findstr :8080

# 2. 杀死占用进程
taskkill /F /PID <进程ID>

# 3. 或者修改配置使用其他端口
.\crawler.exe worker --id=1 --http=:8081 --grpc=:9091
```

### 问题5: 权限问题

**症状**: Docker或文件操作权限不足

**解决方案**:
```powershell
# 1. 以管理员身份运行PowerShell
Start-Process powershell -Verb runAs

# 2. 检查Docker权限
docker version

# 3. 检查文件权限
icacls . /grant Everyone:F
```

## 性能监控

### 基本监控命令

```powershell
# 1. 查看系统资源使用
Get-Process -Name crawler | Select-Object CPU,WorkingSet,VirtualMemorySize

# 2. 查看网络连接
netstat -an | findstr "8080\|8082\|9090\|9092"

# 3. 查看数据库连接数
mysql -u root -p123456 -e "SHOW PROCESSLIST;"

# 4. 查看etcd状态
etcdctl endpoint status --write-out=table
```

### 性能指标

| 指标 | 正常范围 | 监控命令 |
|------|----------|----------|
| CPU使用率 | < 80% | `Get-Counter "\Processor(_Total)\% Processor Time"` |
| 内存使用 | < 2GB | `Get-Process crawler \| Measure-Object WorkingSet -Sum` |
| 网络连接 | < 1000 | `netstat -an \| findstr ESTABLISHED \| Measure-Object` |
| 数据库连接 | < 100 | `mysql -e "SHOW STATUS LIKE 'Threads_connected';"` |

## 下一步学习建议

### 立即可以尝试的实验

1. **修改爬虫任务**:
   ```go
   // 在 parse/minimal/minimal.go 中添加新的解析规则
   // 尝试爬取不同的网站
   ```

2. **调整并发参数**:
   ```toml
   # 在 config.toml 中修改
   [fetcher]
   timeout = "5s"
   # 添加并发控制参数
   ```

3. **添加新的存储方式**:
   ```go
   // 实现 storage.Storage 接口
   // 支持文件存储或Redis存储
   ```

### 深入学习路径

1. **第1周**: 熟悉基本操作和配置
2. **第2周**: 理解分布式协调机制
3. **第3周**: 掌握爬虫规则编写
4. **第4周**: 学习性能优化和监控

### 推荐阅读

- `docs/traeauto/00_项目架构总览.md` - 架构设计理解
- `docs/traeauto/01_核心模块深度解析.md` - 代码实现细节
- `docs/traeauto/02_学习路线图.md` - 系统学习计划

## 总结

通过本快速上手指南，你应该能够:

✅ **环境搭建**: 成功启动完整的分布式爬虫系统
✅ **基本操作**: 添加任务、查看结果、监控状态
✅ **架构理解**: 掌握Master-Worker分布式架构
✅ **问题排查**: 具备基本的故障诊断能力

**下一步**: 根据学习路线图进行深入学习，逐步掌握分布式系统的设计和实现原理。

如果在使用过程中遇到问题，可以:
1. 查看日志文件排查错误
2. 参考常见问题解决方案
3. 阅读详细的架构文档
4. 进行代码调试和分析

祝你学习愉快！🚀