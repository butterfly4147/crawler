# 分布式爬虫项目架构总览

## 项目简介

这是一个基于Go语言的分布式爬虫系统，采用**Master-Worker**架构模式，结合etcd实现服务发现与选举，通过gRPC + HTTP网关对外提供服务。项目来源于极客时间的分布式爬虫课程，展现了完整的微服务架构设计。

## 技术栈概览

### 核心框架
- **微服务框架**: go-micro v4 - 提供服务注册、发现、RPC通信等基础设施
- **RPC通信**: gRPC + grpc-gateway - 内部RPC通信 + HTTP REST API
- **服务发现**: etcd v3.5 - 服务注册发现、配置管理、分布式锁
- **配置管理**: TOML格式 - 任务配置、服务配置等
- **日志系统**: zap - 高性能结构化日志
- **数据库**: MySQL - 数据持久化存储

### 分布式特性
- **选举机制**: 基于etcd的Leader选举，确保Master节点高可用
- **负载均衡**: 最小负载优先的任务分配策略
- **限流控制**: 令牌桶算法控制请求频率
- **容错机制**: 任务重试、故障转移、服务熔断

## 架构设计

### 1. 分布式架构模式

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   HTTP Client   │    │   HTTP Client   │    │   HTTP Client   │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │      Master Cluster       │
                    │  (Leader Election via     │
                    │       etcd)              │
                    └─────────────┬─────────────┘
                                 │ Task Assignment
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                       │                        │
┌───────▼───────┐    ┌──────────▼──────────┐    ┌───────▼───────┐
│   Worker-1    │    │     Worker-2        │    │   Worker-N    │
│  (Crawler     │    │   (Crawler          │    │  (Crawler     │
│   Engine)     │    │    Engine)          │    │   Engine)     │
└───────────────┘    └─────────────────────┘    └───────────────┘
        │                       │                        │
        └───────────────────────┼────────────────────────┘
                               │
                    ┌──────────▼──────────┐
                    │      MySQL          │
                    │   (Data Storage)    │
                    └─────────────────────┘
```

### 2. 核心组件职责

#### Master节点
- **集群管理**: 监控Worker节点状态，维护集群拓扑
- **任务调度**: 根据负载情况分配爬虫任务到Worker节点
- **选举机制**: 通过etcd实现Leader选举，确保高可用
- **资源分配**: 基于最小负载优先策略进行任务分配
- **API网关**: 提供HTTP REST API和gRPC接口

#### Worker节点
- **任务执行**: 执行具体的网页抓取、解析和数据处理
- **引擎管理**: 管理爬虫引擎的生命周期
- **资源监听**: 监听etcd中的资源变化，动态启停任务
- **并发控制**: 管理goroutine池，控制并发度
- **数据存储**: 将解析结果存储到数据库

#### etcd集群
- **服务注册**: Worker节点服务注册与发现
- **配置管理**: 分布式配置存储与同步
- **选举协调**: Master节点Leader选举
- **资源分配**: 任务资源的分配与监听

## 数据流分析

### 任务执行流程

```
1. 任务定义 (config.toml)
   ↓
2. Master选举 (etcd Leader Election)
   ↓
3. 任务分配 (Master → Worker via etcd)
   ↓
4. 网页抓取 (Worker HTTP/Browser Fetch)
   ↓
5. 内容解析 (Rule-based Parsing)
   ↓
6. 数据存储 (MySQL Storage)
   ↓
7. 链接发现 (New URLs → Task Queue)
```

### 分布式协作流程

```
Worker启动 → 服务注册(etcd) → Master监听资源变化 → 负载均衡分配 → 任务执行 → 结果收集
```

## 核心模块架构

### 1. 命令行入口 (`cmd/`)
```
main.go → cmd/cmd.go → {master/master.go, worker/worker.go}
```

### 2. Master模块 (`master/`)
- **选举机制**: 基于etcd的concurrency.Election
- **资源管理**: ResourceSpec、NodeSpec定义
- **负载均衡**: 按Payload选择最空闲节点
- **RPC服务**: CrawlerMaster服务实现

### 3. Engine模块 (`engine/`)
- **调度器**: Schedule接口，管理请求队列
- **爬虫引擎**: Crawler核心逻辑
- **并发控制**: goroutine池管理
- **去重机制**: 基于URL哈希的去重

### 4. Spider模块 (`spider/`)
- **任务定义**: Task结构体
- **请求封装**: Request生命周期管理
- **解析规则**: RuleTree规则树定义
- **上下文管理**: Context解析上下文

### 5. 存储模块 (`storage/`)
- **接口抽象**: Storage接口定义
- **SQL实现**: SQLStorage具体实现
- **批量处理**: dataDocker批量缓冲

## 配置系统

### config.toml结构
```toml
# 日志级别
logLevel = "debug"

# 任务定义
[[Tasks]]
Name = "example_baidu_home"
WaitTime = 1
Reload = true
MaxDepth = 1
Fetcher = "browser"
Limits = [{EventCount=1, EventDur=1, Bucket=1}]

# 抓取器配置
[fetcher]
timeout = 3000
proxy = []

# 存储配置
[storage]
sqlURL = "root:123456@tcp(127.0.0.1:3306)/crawler?charset=utf8"

# gRPC服务配置
[GRPCServer]
HTTPListenAddress = ":8080"
GRPCListenAddress = ":9090"
RegistryAddress = "127.0.0.1:2379"

# Master服务配置
[MasterServer]
RegistryAddress = "127.0.0.1:2379"
Name = "go.micro.server.master"
```

## 部署架构

### Docker Compose部署
```yaml
services:
  master:    # Master节点 (8082/9092)
  worker:    # Worker节点 (8080/9090)  
  etcd:      # 服务发现 (2379/2380)
  mysql:     # 数据存储 (3306)
```

### Kubernetes部署
- Service/Deployment定义
- ConfigMap配置管理
- Ingress流量入口

## 与游戏服务器架构的对比

基于你的游戏服务器开发经验，可以看到以下相似之处：

### 架构模式
- **Master-Worker** ≈ **游戏服务器的主从架构**
- **服务发现** ≈ **游戏服务器的服务注册中心**
- **负载均衡** ≈ **玩家分配到不同游戏服务器**

### 技术实现
- **etcd选举** ≈ **游戏服务器主节点选举**
- **gRPC通信** ≈ **游戏服务器间RPC通信**
- **任务调度** ≈ **游戏任务调度系统**
- **并发控制** ≈ **游戏服务器并发玩家处理**

### 分布式特性
- **故障转移** ≈ **游戏服务器故障切换**
- **状态同步** ≈ **游戏状态同步机制**
- **资源管理** ≈ **游戏资源分配管理**

## 学习建议

基于你的背景，建议按以下顺序学习：

1. **架构理解** (1-2天): 理解Master-Worker模式和服务发现机制
2. **核心模块** (3-5天): 深入Engine调度器、Master选举、Worker执行
3. **分布式特性** (2-3天): 掌握etcd使用、gRPC通信、高可用设计
4. **扩展优化** (2-3天): 性能优化、监控告警、扩展开发

## 快速上手

1. **环境准备**: Go 1.18+, MySQL, etcd
2. **编译运行**: `go build -o crawler.exe .`
3. **启动服务**: etcd → master → worker
4. **验证功能**: 通过HTTP API添加任务
5. **观察日志**: 查看任务执行和数据存储

这个项目展现了完整的分布式系统设计思想，对于有游戏服务器经验的开发者来说，是很好的微服务架构学习案例。